<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title >Web tachdata</title>
    <!-- add 404 by using waiting-web-page/index.html -->
    <!-- <link rel="404-page"href="waiting-web-page/index.html">  -->
    <link rel="website_icon" type="png" href="/static/icons/terminal1.png>
    <script src="https://cdn.tailwindcss.com">
        <style>
        body { 
            display: flex;
            background-image: url("/static/background/bigdatebackground.jpg");
            background-size: cover;
            background-position: center;
            height: 100vh;
            margin: 0;
            padding: 0;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
            font-family: Arial, sans-serif;
            margin : 0;
            padding : 0;

        }
        h1{
            font-size: 40px;
            font-family: 'Times New Roman', Times, serif;
        }
        p{
            font-family:'Times New Roman', Times, serif;
            font-size: large;
            color: red;
        }

        textarea {
            width: 900px;
            height: 230px;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;display: flex;
            flex-direction: column;
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            font-size: 16px;
            resize: none;
        }
        select {
            width: 940px;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            background-color: #f8f9fa;
            font-size: 16px;
        }
        select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
        }

        form{
            font-family: 'Times New Roman', Times, serif;
            font-size: medium;
            align-items: flex-end;
            justify-content: end;
            flex-direction: column;
        }
        input[type="file"]::file-selector-button{
            
            padding:10px 20px;
            border-radius: 5px;
        }
        input[type="file"]::file-selector-button:hover{
            cursor: pointer;
            background-color: orange;
        }
        input{
            justify-content: center;
            padding: 10px ,20px;
            border-radius: 5px ;
        }
        input:hover{
            cursor: pointer ;
        }
        button {
            justify-content: flex-end;
            padding: 10px 20px;
            border-radius: 5px; 
        }
        button:hover{
            cursor: pointer;
            background-color: orange;
        }
        input[type="button"]::file-selector-button:hover{
            cursor: pointer;
            background-color: orange;
        }
        input[type="button"]::file-selector-button{
            justify-content: center;
            padding: 25px ,30px;
            border-radius: 5px ;
        }  

        
        </style>
</head>
<body>
    <h1>Welcome to Web Tachdata</h1>
    <p>Can you first upload your file</p>
    <!-- upload file -->
    <form id="process-botton" enctype="multipart/form-data" alt="upload_form">
        <label for="file">Upload a file:</label>
        <input id="file" type="file" name="file" accept=".txt, .csv, .xlsx">
        <button id="upload-button" type="button">Process File</button>
        <input id="download-button" name="file" type="button" onclick="download" value="Download File" />
    </form>


    <div alt="output_part",
     class="bg-white p-8 rounded-2xl shadow-xl max-w-2xl w-full">
        <!-- A simple heading -->
        <h3 alt="title">Select your task</h3>
        <select name="sellect_part" id ="user_choice"
            id="user_choice",
            class="w-full p-3 text-gray-700 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
            >
            <option value="0">chọn task bạn cần</option>
            <option value="1">1. thay đổi biến</option>
            <option value="2">2. chuyển từ dạng text sang num</option>
            <option value="3">3. Xóa hàng với từng biến được chọn</option>
            <!-- <option value="data_transformation">Data Transformation</option>
            <option value="data_export">Data Export</option> -->
        </select>
        <h3 alt="terminal">Terminal Part</h3>
        <textarea
            id="typing-box"
            class="w-full h-64 p-4 text-gray-700 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 resize-none"
            placeholder=">"
        ></textarea>
    </div>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const terminal = document.getElementById('typing-box');
        const userchoice = document.getElementById('user_choice');
        const form = document.getElementById('process-botton');
        const download = document.getElementById('download-button');
        let prompt = '> '; // use let to easy to modify 


        //update the terminal 
        function updatePrompt(newPrompt){
            prompt = newPrompt;
            const lines = terminal.value.split('\n');

            lines[lines.length - 1] = prompt;
            terminal.value = lines.join('\n');
            terminal.scrollTop = terminal.scrollHeight;
        }

        //Event listem for the select menu 
        userchoice.addEventListener('change',(event) => {
            const selectValue = event.target.value; 
            updatePrompt(selectValue + '> ');
        });

    

        // Set the initial value and focus on the textarea.
        terminal.value = prompt;
        // This line is commented out in your code. It's a good practice to include it
        // to automatically place the cursor in the terminal when the page loads.
        terminal.focus(); 
        //
        form.addEventListener('submit',(event) => {
            event.preventDefault();
            const fileInput = document.getElementById('file');
            const file = fileInput.file[0];
            const selectOption = userchoice.value;
        });

        
        const uploadButton = document.getElementById('upload-button');
        let lastOutputPath = null; // Store the last uploaded file


        // Download button event listener
        const downloadLabel = document.querySelector('label[for="download-button"]');
        download.addEventListener('click', () => {
            if (!lastOutputPath) {
                terminal.value += '\n' + 'No file available for download. Please process a file first.' + '\n' + prompt;
                terminal.scrollTop = terminal.scrollHeight;
                return;
            }

            //initiate the download
            const link = document.createElement('a');
            link.href = `output/${encodeURIComponent(lastOutputPath)}`;
            link.download = lastOutputPath; 
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            terminal.value += '\n' + 'Download started...' + '\n';
            terminal.value += `\ nDownloaded successful file: ${lastOutputPath}\n${prompt}`;
            terminal.scrollTop = terminal.scrollHeight;
        });

        //this is the event listener for the upload button
        uploadButton.addEventListener('click',(event)=>{
            const fileInput = document.getElementById('file');
            const file = fileInput.files[0]; //not reset after click

            const userchoice = document.getElementById('user_choice').value;
        

            if(!file){
                terminal.value += '\n' + 'Please select a file first.' + '\n' + prompt;
                return;
            }

            const formData = new FormData();
            formData.append('file',file);

            let apiEndpoint = '';
            //user selection 

            //user delete_rows
            if (userchoice === "1"){
                apiEndpoint = '/api/replacevar';
                fileInput.value = ''; // Clear the file input after processing
            } else if (userchoice === "2"){
                apiEndpoint = '/api/texttonum';
                fileInput.value = ''; // Clear the file input after processing
            } else if (userchoice === "3"){
                apiEndpoint = '/api/deleterows';
                fileInput.value = ''; // Clear the file input after processing
            } else {
                terminal.value += `\nThis option is not connect to the backend yet.\n${prompt}`;
                fileInput.value = ''; // Clear the file input after processing
                return ;
            }

            terminal.value += `\nUploading and processing file...' \n ${prompt}`;


            fetch(apiEndpoint,{
                method:'POST',
                body: formData
            })
            // .then(response => response.json()) // parse the JSON from the server
            // create a more robust response handler
            .then(async response => {
                const contentType = response.headers.get('Content-Type');
                if (contentType && contentType.includes('application/json')) {
                    const data = await response.json();
                    if (data.error) {
                        terminal.value += `\nError: ${data.error}\n${prompt}`;
                        lastOutputPath = null; // Reset last uploaded file on error
                    } else {
                        terminal.value += `\nSuccess: ${data.message}\nOuput file at: ${data.output_path}\n${prompt}`;
                        lastOutputPath = data.output_path; // Store the output file path
                    }
                } else {
                    const text = await response.text();
                    terminal.value += `\nUnexpected response from server: ${text}\n${prompt}`;
                    lastOutputPath = null; // Reset last uploaded file on unexpected response
                }
                terminal.scrollTop = terminal.scrollHeight;
                fileInput.value = ''; // Clear the file input after processing
            })
            .catch(error => {
                terminal.value += '\n' + `An error occurred: ${error}` + '\n' + prompt;
                terminal.scrollTop = terminal.scrollHeight;
                lastOutputPath = null; // Reset last uploaded file on error
                fileInput.value = ''; // Clear the file input after processing
            });
        });

        terminal.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();

                // Split the content by newlines to get individual lines.
                const lines = terminal.value.split('\n');
                
                // Get the last line where the user typed their command.
                const lastLine = lines[lines.length - 1];
                
                // Extract the command by removing the prompt and any leading/trailing whitespace.
                const command = lastLine.substring(prompt.length).trim();
                
                let output = '';

                switch (command) {
                    case 'help':
                        output = `
Available commands:
  help: Show this help message.
  clear: Clear the terminal screen.
  echo <message>: Repeat the message.
                        `.trim();
                        break;
                    case 'clear':
                        // If the command is 'clear', reset the textarea to just the prompt.
                        terminal.value = prompt;
                        return; // Exit the function to prevent adding a newline.
                    case 'date':
                        output = new Date().toLocaleString();
                        break;

                    
                    default:
                        if (command.startsWith('echo')) {
                            // If the command is 'echo', get the message after 'echo'.
                            output = command.substring(5).trim();
                        } else {
                            // If the command is not recognized, show an error message.
                            output = `Error: command not found: ${command}`;
                        }
                }
                
                // Add the output and a new prompt line to the textarea's value.
                terminal.value += '\n' + output + '\n' + prompt;

                // Automatically scroll to the bottom to show the latest output.
                terminal.scrollTop = terminal.scrollHeight;
            }
        });
    });
</script>
</body>
</html>